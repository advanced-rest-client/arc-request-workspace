<!DOCTYPE html><html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
    <title>api-request-editor demo</title>
    <script>
    if (location.search.indexOf('response_type') !== -1 &&
      location.search.indexOf('redirect_uri') !== -1) {
      // OAUTH DEMO
      /* global URLSearchParams */
      const p = new URLSearchParams(location.search);
      const state = p.get('state');
      const type = p.get('response_type');
      let red = p.get('redirect_uri');
      red += '?state=' + state;
      if (type === 'token') {
        red += '&access_token=ya.12345.asdfghh';
      } else {
        red += '&code=12345Zasdfghh';
      }
      location.href = red;
    }
    </script>
    <script src="../../../@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../../web-animations-js/web-animations-next.min.js"></script>

    <script type="module" src="../../../@webcomponents/shadycss/entrypoints/apply-shim.js"></script>
    <script type="module" src="../../../@polymer/polymer/lib/elements/custom-style.js"></script>
    <script type="module" src="../../../@polymer/polymer/lib/elements/dom-bind.js"></script>
    <script type="module" src="../../../@advanced-rest-client/arc-models/project-model.js"></script>
    <script type="module" src="../../../@advanced-rest-client/arc-models/request-model.js"></script>
    <script type="module" src="../../../@advanced-rest-client/arc-models/variables-model.js"></script>
    <script type="module" src="../../../@advanced-rest-client/variables-evaluator/variables-evaluator.js"></script>
    <script type="module" src="../../../@advanced-rest-client/variables-manager/variables-manager.js"></script>
    <script type="module" src="../../../@advanced-rest-client/variables-editor/variables-editor.js"></script>
    <script type="module" src="../../../@advanced-rest-client/arc-models/url-history-model.js"></script>
    <script type="module" src="../../../@advanced-rest-client/arc-models/url-indexer.js"></script>
    <script type="module" src="../../../@advanced-rest-client/request-hooks-logic/request-hooks-logic.js"></script>
    <script type="module" src="../../../@advanced-rest-client/arc-request-logic/arc-request-logic.js"></script>
    <script type="module" src="../../../@advanced-rest-client/oauth-authorization/oauth2-authorization.js"></script>
    <script type="module" src="../../../@advanced-rest-client/oauth-authorization/oauth1-authorization.js"></script>
    <script type="module" src="../../../@polymer/paper-dropdown-menu/paper-dropdown-menu.js"></script>
    <script type="module" src="../../../@polymer/iron-demo-helpers/demo-snippet.js"></script>
    <script type="module" src="../../../@advanced-rest-client/arc-electron-default-theme/arc-electron-default-theme.js"></script>
    <script type="module" src="../../../@polymer/paper-styles/shadow.js"></script>
    <script type="module" src="../../../@advanced-rest-client/saved-menu/saved-menu.js"></script>
    <script type="module" src="../../../@advanced-rest-client/projects-menu/projects-menu.js"></script>
    <script type="module" src="../../../@advanced-rest-client/history-menu/history-menu.js"></script>
    <script type="module" src="../../../@polymer/paper-toast/paper-toast.js"></script>
    <script type="module" src="../../../@advanced-rest-client/saved-request-editor/saved-request-editor.js"></script>
    <script type="module" src="../../../@advanced-rest-client/saved-request-detail/saved-request-detail.js"></script>
    <script type="module" src="../../../@advanced-rest-client/bottom-sheet/bottom-sheet.js"></script>
    <script type="module" src="../../../@advanced-rest-client/http-code-snippets/http-code-snippets.js"></script>
    <script type="module" src="../../../@polymer/paper-input/paper-input.js"></script>
    <script type="module" src="../../../@polymer/paper-icon-button/paper-icon-button.js"></script>
    <script type="module" src="../../../@advanced-rest-client/arc-icons/arc-icons.js"></script>
    <script type="module" src="../../../@polymer/paper-dropdown-menu/paper-dropdown-menu.js"></script>
    <script type="module" src="../../../@polymer/paper-item/paper-item.js"></script>
    <script type="module" src="../../../@polymer/paper-listbox/paper-listbox.js"></script>
    <script type="module" src="../../../@polymer/paper-checkbox/paper-checkbox.js"></script>
    <script type="module" src="../../../@polymer/paper-tabs/paper-tabs.js"></script>
    <script type="module" src="../../../@polymer/paper-tabs/paper-tab.js"></script>
    <script type="module" src="../arc-request-workspace.js"></script>

    <script src="../dev-lib/jexl.min.js"></script>

    <!-- CodeMirror + modes loader -->
    <script src="../../../codemirror/lib/codemirror.js"></script>
    <script src="../../../codemirror/addon/mode/loadmode.js"></script>
    <script src="../../../codemirror/mode/meta.js"></script>
    <!--Default set of parsers, add as many as you need -->
    <script src="../../../codemirror/mode/javascript/javascript.js"></script>
    <script src="../../../codemirror/mode/xml/xml.js"></script>
    <script src="../../../codemirror/mode/htmlmixed/htmlmixed.js"></script>
    <!-- JSON linter -->
    <script src="../../../jsonlint/lib/jsonlint.js"></script>
    <script src="../../../codemirror/addon/lint/lint.js"></script>
    <script src="../../../codemirror/addon/lint/json-lint.js"></script>
    <!-- Headers hint support -->
    <script src="../../../@advanced-rest-client/code-mirror-hint/headers-addon.js"></script>
    <script src="../../../@advanced-rest-client/code-mirror-hint/show-hint.js"></script>
    <script src="../../../@advanced-rest-client/code-mirror-hint/hint-http-headers.js"></script>

    <script>
    CodeMirror.modeURL = '../../../codemirror/mode/%N/%N.js';
    </script>

    <style>
    body,
    html {
      background-color: #e5e5e5;
      height: 100vh;
      margin: 0;
      padding: 0;
    }
    </style>

    <custom-style>
      <style is="custom-style">
      h1 {
        @apply --paper-font-headline;
      }

      h2 {
        @apply --paper-font-title;
      }

      .card {
        @apply --shadow-elevation-4dp;
        padding: 20px;
        margin-top: 20px;
        margin-bottom: 20px;
        box-sizing: border-box;
        background-color: #fff;
      }

      .app {
        @apply --layout-horizontal;
        height: 100vh;
      }

      nav {
        min-width: 256px;
        width: 256px;
        height: 100vh;
        background-color: #fff;
      }

      projects-menu,
      history-menu,
      saved-menu {
        overflow: auto;
        width: 256px;
        height: calc(100vh - 58px);
      }

      .main {
        @apply --layout-flex;
        height: 100vh;
        overflow: auto;
        margin: 0 24px;
      }

      arc-request-workspace {
        width: 100%;
        max-width: 1100px;
      }

      .main > div {
        max-width: 1100px;
      }

      bottom-sheet {
        width: 60%;
        max-width: 700px;
      }

      .search {
        margin-left: 12px;
        margin-right: 12px;
      }
      </style>
    </custom-style>
  </head>
  <body>
    <variables-model></variables-model>
    <url-history-model></url-history-model>
    <variables-manager></variables-manager>
    <project-model></project-model>
    <request-model></request-model>
    <url-indexer></url-indexer>
    <variables-evaluator id="eval" no-before-request=""></variables-evaluator>
    <oauth2-authorization></oauth2-authorization>
    <oauth1-authorization></oauth1-authorization>
    <arc-request-logic></arc-request-logic>
    <request-hooks-logic></request-hooks-logic>

    <dom-bind id="demo">
      <template is="dom-bind">
        <div class="app">
          <nav>
            <paper-tabs selected="{{selectedMenu}}">
              <paper-tab>History</paper-tab>
              <paper-tab>Saved</paper-tab>
              <paper-tab>Projects</paper-tab>
            </paper-tabs>
            <iron-pages selected="[[selectedMenu]]">
              <history-menu id="historyMenu" on-navigate="_selectRequest" draggable-enabled="" list-type="[[listType]]"></history-menu>
              <div>
                <div class="search">
                  <paper-input label="Search" class="search" no-label-float="" value="{{q}}" on-keydown="_searchKeydown">
                    <paper-icon-button icon="arc:search" slot="suffix" on-click="_search"></paper-icon-button>
                  </paper-input>
                </div>
                <saved-menu on-navigate="_selectRequest" draggable-enabled=""></saved-menu>
              </div>
              <projects-menu id="projectsMenu" on-navigate="_selectRequest" draggable-enabled="" list-type="[[listType]]"></projects-menu>
            </iron-pages>

          </nav>
          <section class="main">
            <div class="centered card">
              <arc-request-workspace oauth2-redirect-uri="[[oauth2RedirectUri]]" draggable-enabled=""></arc-request-workspace>
            </div>

            <div class="centered card">
              <paper-button on-click="generateData">Generate 100 saved items</paper-button>
              <paper-button on-click="clearData">Clear datastore</paper-button>
              <paper-button on-click="openWebUrlInput">Open web URL input</paper-button>
            </div>

            <div class="centered card">
              <h2>Select project to restore</h2>
              <paper-dropdown-menu label="Project name">
                <paper-listbox slot="dropdown-content" selected="{{project}}">
                  <template is="dom-repeat" items="[[projects]]">
                    <paper-item>[[item.name]] ([[item.requests.length]])</paper-item>
                  </template>
                </paper-listbox>
              </paper-dropdown-menu>
              <paper-checkbox checked="{{projectReplace}}">Replace requests in workspace</paper-checkbox>
              <paper-button on-click="getProjectRequestsData">Open requests</paper-button>
            </div>

            <div class="vertical-section-container centered card">
              <h4>Demo: Variables editor</h4>
              <variables-editor></variables-editor>
            </div>

            <div class="vertical-section-container centered card">
              <h4>Workspace configuration</h4>
              <paper-input label="Request timeout" value="{{requestTimeout}}" type="number" step="1" min="0" on-change="_requestTimeoutChanged"></paper-input>
              <paper-input label="Sent message preview bytes limit" value="{{sentMessageLimit}}" type="number" step="1" min="0" on-change="_sentMessageLimitChanged"></paper-input>
              <paper-toggle-button checked="{{validateCertificates}}" on-change="_validateCertificatesChanged">Validate certificates</paper-toggle-button>
              <paper-toggle-button checked="{{followRedirects}}" on-change="_followRedirectsChanged">Follow redirects</paper-toggle-button>
              <paper-input label="OAuth2 redirect URI" type="url" on-change="_setOauth2RedirectUri"></paper-input>
            </div>
          </section>
        </div>
      </template>
    </dom-bind>
    <paper-toast id="genToast" text="The request data has been generated"></paper-toast>
    <paper-toast id="clearToast" text="The request data has been removed"></paper-toast>
    <paper-toast id="webUrlToast" text="Open web URL requested via event"></paper-toast>
    <script type="module">
    import {DataGenerator} from '../../arc-data-generator/arc-data-generator.js';
    /* global chance */
    (function(app) {
      // const redirectUrl = location.href.replace(/request-editor\/demo\/(index\.html)?/,
      //   'oauth-authorization/oauth-popup.html');
      // app.oauth2RedirectUri = redirectUrl;
      app.projectReplace = false;
      app.selectedMenu = 0;
      app.init = function() {
        app.refreshProjects();
      };
      app.createHeaders = function(data) {
        const headers = new Headers();
        if (data) {
          data.split('\n').forEach((line) => {
            const pair = line.split(':');
            const n = pair[0] ? pair[0].trim() : '';
            if (!n) {
              return;
            }
            const v = pair[1] ? pair[1].trim() : '';
            headers.append(n, v);
          });
        }
        return headers;
      };

      app.send = function(e) {
        const request = e.detail;
        const init = {
          method: request.method,
          headers: app.createHeaders(request.headers)
        };
        if (['GET', 'HEAD'].indexOf(request.method) === -1 && request.payload) {
          init.body = request.payload;
        }
        app.rsp = {
          id: request.id,
          request: request,
          response: {},
          isXhr: true,
          loadingTime: 0
        };
        const startTime = Date.now();
        return fetch(request.url, init)
        .then((response) => {
          app.rsp.loadingTime = Date.now() - startTime;
          let headers = '';
          response.headers.forEach((value, name) => {
            headers += `${name}: ${value}\n`;
          });
          app.rsp.response.headers = headers;
          app.rsp.response.status = response.status;
          app.rsp.response.statusText = response.statusText;
          app.rsp.response.url = response.url;
          return response.text();
        })
        .then((body) => {
          app.rsp.response.payload = body;
          document.body.dispatchEvent(new CustomEvent('report-response', {
            bubbles: true,
            detail: app.rsp
          }));
        })
        .catch((cause) => {
          app.rsp.isError = true;
          app.rsp.error = cause;
          app.rsp.loadingTime = Date.now() - startTime;
          document.body.dispatchEvent(new CustomEvent('report-response', {
            bubbles: true,
            detail: app.rsp
          }));
        });
      };
      app._restoreHandler = function(e) {
        e.preventDefault();
        e.detail.result = new Promise((resolve) => {
          const reqStr = localStorage.getItem('workspace.requests');
          let requests;
          if (reqStr) {
            try {
              requests = JSON.parse(reqStr);
            } catch (_) {
              requests = [];
            }
          }
          let environment = localStorage.getItem('workspace.environment');
          let selected;
          let selStr = localStorage.getItem('workspace.selected');
          if (selStr && !isNaN(selStr)) {
            selected = Number(selStr);
          }
          const configStr = localStorage.getItem('workspace.config');
          let config;
          if (configStr) {
            try {
              config = JSON.parse(configStr);
            } catch (_) {
              config = {};
            }
          }
          const variablesStr = localStorage.getItem('workspace.variables');
          let variables;
          if (variablesStr) {
            try {
              variables = JSON.parse(variablesStr);
            } catch (_) {}
          }
          const webSessionStr = localStorage.getItem('workspace.webSession');
          let webSession;
          if (webSessionStr) {
            try {
              webSession = JSON.parse(webSessionStr);
            } catch (_) {}
          }
          const authStr = localStorage.getItem('workspace.auth');
          let auth;
          if (authStr) {
            try {
              auth = JSON.parse(authStr);
            } catch (_) {}
          }

          const version = localStorage.getItem('workspace.version') || undefined;
          const published = localStorage.getItem('workspace.published') || undefined;
          let provider;
          const providerStr = localStorage.getItem('workspace.provider');
          if (providerStr) {
            try {
              provider = JSON.parse(providerStr);
            } catch (_) {}
          }

          const result = {
            kind: 'ARC#Workspace',
            version,
            published,
            provider,
            selected,
            environment,
            requests,
            config,
            variables,
            webSession,
            auth
          };
          if (config) {
            if (config.requestTimeout) {
              app.requestTimeout = Number(config.requestTimeout);
            }
            if (config.sentMessageLimit) {
              app.sentMessageLimit = Number(config.sentMessageLimit);
            }
            if (config.followRedirects) {
              app.followRedirects = Boolean(config.followRedirects);
            }
            if (config.validateCertificates) {
              app.validateCertificates = Boolean(config.validateCertificates);
            }
          }
          setTimeout(() => {
            resolve(result);
          });
        });
      };

      app._storeHandler = function(e) {
        e.preventDefault();
        const {environment, selected, requests, config, variables, webSession,
          auth, version, published, provider} = e.detail.value;
        console.info('Storing workspace data', e.detail.value);
        if (requests) {
          const requestsStr = JSON.stringify(requests);
          localStorage.setItem('workspace.requests', requestsStr);
        }
        if (environment) {
          localStorage.setItem('workspace.environment', environment);
        }
        if (config) {
          const consfigStr = JSON.stringify(config);
          localStorage.setItem('workspace.config', consfigStr);
        }
        if (variables) {
          const variablesStr = JSON.stringify(variables);
          localStorage.setItem('workspace.variables', variablesStr);
        }
        if (webSession) {
          const webSessionStr = JSON.stringify(webSession);
          localStorage.setItem('workspace.webSession', webSessionStr);
        }
        if (auth) {
          const authStr = JSON.stringify(auth);
          localStorage.setItem('workspace.auth', authStr);
        }
        if (version) {
          localStorage.setItem('workspace.version', version);
        }
        if (published) {
          localStorage.setItem('workspace.published', published);
        }
        if (provider) {
          localStorage.setItem('workspace.provider', JSON.stringify(provider));
        }
        localStorage.setItem('workspace.selected', selected);
      };

      app.generateData = function() {
        DataGenerator.insertSavedRequestData({
          requestsSize: 100
        })
        .then(() => {
          document.getElementById('genToast').opened = true;
          document.body.dispatchEvent(new CustomEvent('data-imported', {
            bubbles: true
          }));
        });
      };
      app.clearData = function() {
        DataGenerator.destroySavedRequestData()
        .then(() => {
          document.getElementById('clearToast').opened = true;
          document.body.dispatchEvent(new CustomEvent('datastore-destroyed', {
            detail: {
              datastore: 'all'
            },
            bubbles: true
          }));
        });
      };
      app._selectRequest = function(e) {
        const workspace = document.querySelector('arc-request-workspace');
        const {base, type, id} = e.detail;
        if (base === 'project') {
          return;
        }
        workspace.addRequestById(type, id);
      };
      //
      // Google drive export flow
      //
      app._exportDriveHandler = function(e) {
        e.preventDefault();
        e.detail.result = Promise.resolve({
          id: chance.guid({version: 5})
        });
      };
      //
      // Search saved
      //
      app._searchKeydown = function(e) {
        if (e.code === 'Enter') {
          app._search();
        }
      };
      app._search = function() {
        if (!app.q) {
          document.querySelector('saved-menu').refresh();
          return;
        }
        const e = new CustomEvent('request-query', {
          cancelable: true,
          bubbles: true,
          detail: {
            type: 'saved',
            q: app.q
          }
        });
        document.body.dispatchEvent(e);
        e.detail.result
        .then((items) => {
          document.querySelector('saved-menu').requests = items;
        });
      };
      app.refreshProjects = function() {
        const e = new CustomEvent('project-model-query', {
          cancelable: true,
          bubbles: true,
          detail: {}
        });
        document.body.dispatchEvent(e);
        e.detail.result
        .then((data) => {
          console.log('Projects query result', data);
          app.projects = data;
        });
      };
      app.getProjectRequestsData = function() {
        const project = app.projects[app.project];
        if (!project) {
          return;
        }
        const workspace = document.querySelector('arc-request-workspace');
        if (app.projectReplace) {
          workspace.replaceByProject(project);
        } else {
          workspace.appendByProject(project);
        }
      };
      // Mocking of the data export component.
      document.body.addEventListener('export-data', function(e) {
        e.preventDefault();
        e.detail.result = new Promise((resolve) => {
          resolve();
        });
      });

      app._requestTimeoutChanged = () => {
        const workspace = document.querySelector('arc-request-workspace');
        workspace.requestTimeout = Number(app.requestTimeout);
      };
      app._sentMessageLimitChanged = () => {
        const workspace = document.querySelector('arc-request-workspace');
        workspace.sentMessageLimit = Number(app.sentMessageLimit);
      };
      app._setOauth2RedirectUri = () => {
        const workspace = document.querySelector('arc-request-workspace');
        workspace._workspaceOauth2RedirectUri = app.oauth2RedirectUri;
      };
      app._validateCertificatesChanged = () => {
        const workspace = document.querySelector('arc-request-workspace');
        workspace.validateCertificates = app.validateCertificates;
      };
      app._followRedirectsChanged = () => {
        const workspace = document.querySelector('arc-request-workspace');
        workspace.followRedirects = app.followRedirects;
      };

      app.openWebUrlInput = () => {
        const workspace = document.querySelector('arc-request-workspace');
        workspace.openWebUrlInput();
      };

      app._openWebUrlHandler = () => {
        document.getElementById('webUrlToast').opened = true;
      };
      window.addEventListener('transport-request', app.send);
      window.addEventListener('workspace-state-read', app._restoreHandler);
      window.addEventListener('workspace-state-store', app._storeHandler);
      window.addEventListener('request-save-state', app._saveRequestHandler);
      window.addEventListener('request-details', app._requestDetailsHandler);
      window.addEventListener('request-code-snippets', app._renderCodeSnippets);
      window.addEventListener('export-google-drive', app._exportDriveHandler);
      window.addEventListener('open-web-url', app._openWebUrlHandler);
      window.addEventListener('WebComponentsReady', app.init);
    })(document.getElementById('demo'));
    </script>
</body>
</html>
