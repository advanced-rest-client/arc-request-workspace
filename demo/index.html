<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
    <title>api-request-editor demo</title>
    <script>
    if (location.search.indexOf('response_type') !== -1 &&
      location.search.indexOf('redirect_uri') !== -1) {
      // OAUTH DEMO
      var p = new URLSearchParams(location.search);
      var state = p.get('state');
      var type = p.get('response_type');
      var red = p.get('redirect_uri');
      red += '?state=' + state;
      if (type === 'token') {
        red += '&access_token=ya.12345.asdfghh';
      } else {
        red += '&code=12345Zasdfghh';
      }
      location.href = red;
    }
    </script>
    <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
    <link rel="import" href="../../shadycss/apply-shim.html">
    <link rel="import" href="../../polymer/lib/elements/custom-style.html">
    <link rel="import" href="../../polymer/lib/elements/dom-bind.html">
    <link rel="import" href="../../app-pouchdb/pouchdb.html">
    <link rel="import" href="../../neon-animation/web-animations.html">
    <link rel="import" href="../../variables-evaluator/variables-evaluator.html">
    <link rel="import" href="../../variables-manager/variables-manager.html">
    <link rel="import" href="../../url-history-saver/url-history-saver.html">
    <link rel="import" href="../../request-hooks-logic/request-hooks-logic.html">
    <link rel="import" href="../../arc-request-logic/arc-request-logic.html">
    <link rel="import" href="../../oauth-authorization/oauth2-authorization.html">
    <link rel="import" href="../../oauth-authorization/oauth1-authorization.html">
    <link rel="import" href="../../paper-dropdown-menu/paper-dropdown-menu.html">
    <link rel="import" href="../../iron-demo-helpers/demo-pages-shared-styles.html">
    <link rel="import" href="../../iron-demo-helpers/demo-snippet.html">
    <link rel="import" href="../arc-request-workspace.html">
    <custom-style>
      <style is="custom-style" include="demo-pages-shared-styles">
      .vertical-section-container {
        max-width: 1100px;
      }
      </style>
    </custom-style>
  </head>
  <body>
    <url-history-saver></url-history-saver>
    <variables-manager></variables-manager>
    <variables-evaluator id="eval" no-before-request></variables-evaluator>
    <oauth2-authorization></oauth2-authorization>
    <oauth1-authorization></oauth1-authorization>
    <arc-request-logic></arc-request-logic>
    <request-hooks-logic></request-hooks-logic>
    <dom-bind id="demo">
      <template is="dom-bind">
        <div class="vertical-section-container centered" role="main">
          <arc-request-workspace></arc-request-workspace>
        </div>
      </template>
    </dom-bind>
    <script>
    (function(app) {
      app.createHeaders = function(data) {
        const headers = new Headers();
        if (data) {
          data.split('\n').forEach((line) => {
            const pair = line.split(':');
            const n = pair[0] ? pair[0].trim() : '';
            if (!n) {
              return;
            }
            const v = pair[1] ? pair[1].trim() : '';
            headers.append(n, v);
          });
        }
        return headers;
      };

      app.send = function(e) {
        const request = e.detail;
        const init = {
          method: request.method,
          headers: app.createHeaders(request.headers)
        };
        if (['GET', 'HEAD'].indexOf(request.method) === -1 && request.payload) {
          init.body = request.payload;
        }
        app.rsp = {
          id: request.id,
          request: request,
          response: {},
          isXhr: true,
          loadingTime: 0
        };
        const startTime = Date.now();
        return fetch(request.url, init)
        .then((response) => {
          app.rsp.loadingTime = Date.now() - startTime;
          let headers = '';
          response.headers.forEach((value, name) => {
            headers += `${name}: ${value}\n`;
          });
          app.rsp.response.headers = headers;
          app.rsp.response.status = response.status;
          app.rsp.response.statusText = response.statusText;
          app.rsp.response.url = response.url;
          return response.text();
        })
        .then((body) => {
          app.rsp.response.payload = body;
          document.body.dispatchEvent(new CustomEvent('report-response', {
            bubbles: true,
            detail: app.rsp
          }));
        })
        .catch((cause) => {
          app.rsp.isError = true;
          app.rsp.error = cause;
          app.rsp.loadingTime = Date.now() - startTime;
          document.body.dispatchEvent(new CustomEvent('report-response', {
            bubbles: true,
            detail: app.rsp
          }));
        });
      };
      window.addEventListener('transport-request', app.send);
    })(document.getElementById('demo'));
  </script>
  </body>
</html>
