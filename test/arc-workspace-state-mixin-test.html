<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
  <title>ArcWorkspaceStateMixin test</title>
  <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <link rel="import" href="../arc-request-workspace.html">
  <link rel="import" href="../../arc-data-generator/arc-data-generator.html">
  <link rel="import" href="../../arc-models/project-model.html">
  <link rel="import" href="../../arc-models/request-model.html">
  <link rel="import" href="../../arc-models/variables-model.html">
</head>
<body>
  <project-model></project-model>
  <request-model></request-model>
  <variables-model></variables-model>

  <test-fixture id="Basic">
    <template>
      <arc-request-workspace no-auto-projects no-auto-restore></arc-request-workspace>
    </template>
  </test-fixture>

  <script>
  /* global DataGenerator */
  suite('ArcWorkspaceStateMixin', () => {
    suite('_dispatchWorkspaceState()', () => {
      let element;
      setup(() => {
        element = fixture('Basic');
      });

      test('Dispatches workspace-state-read event', () => {
        const spy = sinon.spy();
        element.addEventListener('workspace-state-read', spy);
        element._dispatchWorkspaceState();
        assert.isTrue(spy.called);
      });

      test('Returns the event', () => {
        const e = element._dispatchWorkspaceState();
        assert.typeOf(e, 'customevent');
      });

      test('Event has type on detail', () => {
        const e = element._dispatchWorkspaceState();
        assert.equal(e.detail.type, 'workspace-state');
      });
    });

    suite('_restoreModelError()', () => {
      let element;
      setup(() => {
        element = fixture('Basic');
      });

      test('Returns rejected promise', () => {
        const result = element._restoreModelError();
        assert.typeOf(result.then, 'function');
        return result.then(() => {
          throw new Error('Should not result.');
        })
        .catch((cause) => {
          assert.equal(cause.message, '"workspace-state-read" event for workspace state not handled');
        });
      });

      test('Calls addEmptyRequest()', () => {
        const spy = sinon.spy(element, 'addEmptyRequest');
        return element._restoreModelError()
        .catch(() => {})
        .then(() => {
          assert.isTrue(spy.called);
        });
      });

      test('Sets restoring flag to false', () => {
        element._setRestoring(true);
        return element._restoreModelError()
        .catch(() => {})
        .then(() => {
          assert.isFalse(element.restoring);
        });
      });

      test('Sets initialized flag to true', () => {
        element._setInitialized(false);
        return element._restoreModelError()
        .catch(() => {})
        .then(() => {
          assert.isTrue(element.initialized);
        });
      });
    });

    suite('_restoreRequests()', () => {
      let element;
      setup(() => {
        element = fixture('Basic');
      });

      test('Calls addEmptyRequest() when no requests', () => {
        const spy = sinon.spy(element, 'addEmptyRequest');
        element._restoreRequests();
        assert.isTrue(spy.called);
      });

      test('Calls addEmptyRequest() when requests array empty', () => {
        const spy = sinon.spy(element, 'addEmptyRequest');
        element._restoreRequests([]);
        assert.isTrue(spy.called);
      });

      test('Calls refreshTabs() when not requests', () => {
        const spy = sinon.spy(element, 'refreshTabs');
        element._restoreRequests();
        assert.isTrue(spy.called);
      });

      test('Calls appendRequest() for each request in the array', () => {
        const requests = DataGenerator.generateRequests({
          requestsSize: 2
        });
        const spy = sinon.spy(element, 'appendRequest');
        element._restoreRequests(requests);
        assert.equal(spy.callCount, 2);
      });

      test('Calls refreshTabs() when adding requests', () => {
        const requests = DataGenerator.generateRequests({
          requestsSize: 2
        });
        const spy = sinon.spy(element, 'refreshTabs');
        element._restoreRequests(requests);
        assert.isTrue(spy.called);
      });

      test('Generates _id when missing', () => {
        const requests = DataGenerator.generateRequests({
          requestsSize: 2
        });
        requests.forEach((i) => {
          delete i._id;
        });
        element._restoreRequests(requests);
        requests.forEach((i) => {
          assert.typeOf(i._id, 'string');
        });
      });
    });

    suite('_restoreSelected()', () => {
      let element;
      setup(() => {
        element = fixture('Basic');
      });

      test('Set selection to passed number', () => {
        element._restoreSelected(2);
        assert.equal(element.selected, 2);
      });

      test('Set selection to passed number when argument is a string', () => {
        element._restoreSelected('2');
        assert.equal(element.selected, 2);
      });

      test('Selects latest request when argument is not a number', () => {
        element.activeRequests = [{}, {}];
        element._restoreSelected();
        assert.equal(element.selected, 1);
      });
    });

    suite('_restoreEnvironment()', () => {
      let element;
      const env = 'not-default';
      setup(() => {
        element = fixture('Basic');
      });

      test('Set environment property', () => {
        element._restoreEnvironment(env);
        assert.equal(element.environment, env);
      });

      test('Calls _dispatch() with arguments', () => {
        const spy = sinon.spy(element, '_dispatch');
        element._restoreEnvironment(env);
        assert.isTrue(spy.called);
        assert.equal(spy.args[0][0], 'selected-environment-changed', 'Event type is set');
        assert.equal(spy.args[0][1].value, env, 'detail.value is set');
      });

      test('Does nothing when environment is not set', () => {
        element._restoreEnvironment();
        assert.isUndefined(element.environment);
      });
    });

    suite('_afterRestore()', () => {
      let element;
      setup(() => {
        element = fixture('Basic');
      });

      test('Forces selection change', (done) => {
        element.selected = 1;
        const spy = sinon.spy();
        element.addEventListener('selected-changed', spy);
        element._afterRestore();
        Polymer.RenderStatus.afterNextRender(element, () => {
          assert.equal(spy.callCount, 2);
          done();
        });
      });

      test('Sets restoring flag to false', (done) => {
        element._setRestoring(true);
        element._afterRestore();
        Polymer.RenderStatus.afterNextRender(element, () => {
          assert.isFalse(element.restoring);
          done();
        });
      });

      test('Sets initialized flag to true', (done) => {
        element._setInitialized(false);
        element._afterRestore();
        Polymer.RenderStatus.afterNextRender(element, () => {
          assert.isTrue(element.initialized);
          done();
        });
      });
    });

    suite('_restore()', () => {
      let element;
      setup(() => {
        element = fixture('Basic');
      });

      test('Calls addEmptyRequest() when no state', () => {
        const spy = sinon.spy(element, 'addEmptyRequest');
        element._restore();
        assert.isTrue(spy.called);
      });

      test('Won\'t call _restoreRequests() when no state', () => {
        const spy = sinon.spy(element, '_restoreRequests');
        element._restore();
        assert.isFalse(spy.called);
      });

      test('Calls _restoreRequests()', () => {
        const spy = sinon.spy(element, '_restoreRequests');
        const requests = DataGenerator.generateRequests({
          requestsSize: 2
        });
        element._restore({
          requests
        });
        assert.isTrue(spy.called);
        assert.deepEqual(spy.args[0][0], requests);
      });

      test('Calls _restoreSelected()', () => {
        const spy = sinon.spy(element, '_restoreSelected');
        element._restore({
          selected: 1
        });
        assert.isTrue(spy.called);
        assert.equal(spy.args[0][0], 1);
      });

      test('Calls _restoreEnvironment()', () => {
        const env = 'other-env';
        const spy = sinon.spy(element, '_restoreEnvironment');
        element._restore({
          environment: env
        });
        assert.isTrue(spy.called);
        assert.equal(spy.args[0][0], env);
      });
    });

    suite('restoreWorkspace()', () => {
      let element;
      setup(() => {
        element = fixture('Basic');
      });

      function dataFactory(e) {
        e.preventDefault();
        e.detail.result = new Promise((resolve) => {
          const requests = DataGenerator.generateRequests({
            requestsSize: 2
          });

          resolve({
            requests,
            selected: 1,
            environment: 'other-env'
          });
        });
      }

      function noopFactory(e) {
        e.preventDefault();
        e.detail.result = Promise.resolve({});
      }

      function errorFactory(e) {
        e.preventDefault();
        e.detail.result = Promise.reject(new Error('test'));
      }

      test('Clears activeRequests when set', (done) => {
        element.activeRequests = DataGenerator.generateRequests({
          requestsSize: 2
        });
        element.addEventListener('workspace-state-read', noopFactory);
        element.restoreWorkspace();
        element.removeEventListener('workspace-state-read', noopFactory);
        assert.deepEqual(element.activeRequests, []);
        Polymer.RenderStatus.afterNextRender(element, () => {
          done();
        });
      });

      test('Sets restoring to true', (done) => {
        element.addEventListener('workspace-state-read', noopFactory);
        element.restoreWorkspace();
        element.removeEventListener('workspace-state-read', noopFactory);
        assert.isTrue(element.restoring);
        Polymer.RenderStatus.afterNextRender(element, () => {
          done();
        });
      });

      test('Calls _dispatchWorkspaceState()', (done) => {
        const spy = sinon.spy(element, '_dispatchWorkspaceState');
        element.addEventListener('workspace-state-read', noopFactory);
        element.restoreWorkspace();
        element.removeEventListener('workspace-state-read', noopFactory);
        assert.isTrue(spy.called);
        Polymer.RenderStatus.afterNextRender(element, () => {
          done();
        });
      });

      test('Calls _restoreModelError() when no model', (done) => {
        const spy = sinon.spy(element, '_restoreModelError');
        element.restoreWorkspace()
        .catch(() => {});
        assert.isTrue(spy.called);
        Polymer.RenderStatus.afterNextRender(element, () => {
          done();
        });
      });

      test('Restores defaults when no state', (done) => {
        element.addEventListener('workspace-state-read', noopFactory);
        element.restoreWorkspace()
        .then(() => {
          Polymer.RenderStatus.afterNextRender(element, () => {
            assert.lengthOf(element.activeRequests, 1);
            assert.equal(element.selected, 0);
            assert.isUndefined(element.environment);
            done();
          });
        });
        element.removeEventListener('workspace-state-read', noopFactory);
      });

      test('Restores state', (done) => {
        element.addEventListener('workspace-state-read', dataFactory);
        element.restoreWorkspace()
        .then(() => {
          Polymer.RenderStatus.afterNextRender(element, () => {
            assert.lengthOf(element.activeRequests, 2);
            assert.equal(element.selected, 1);
            assert.equal(element.environment, 'other-env');
            done();
          });
        });
        element.removeEventListener('workspace-state-read', dataFactory);
      });

      test('Handles restoration errors', (done) => {
        element.addEventListener('workspace-state-read', errorFactory);
        element.restoreWorkspace()
        .then(() => {
          Polymer.RenderStatus.afterNextRender(element, () => {
            assert.lengthOf(element.activeRequests, 1);
            assert.equal(element.selected, 0);
            assert.isUndefined(element.environment);
            done();
          });
        });
        element.removeEventListener('workspace-state-read', errorFactory);
      });
    });

    suite('serializeWorkspace()', () => {
      let element;
      setup(() => {
        element = fixture('Basic');
      });

      test('Returns object', () => {
        const result = element.serializeWorkspace();
        assert.typeOf(result, 'object');
      });

      test('Sets default environment', () => {
        const result = element.serializeWorkspace();
        assert.equal(result.environment, 'default');
      });

      test('Sets default selected', () => {
        const result = element.serializeWorkspace();
        assert.equal(result.selected, 0);
      });

      test('Sets default requests', () => {
        const old = element.activeRequests;
        element.activeRequests = undefined;
        const result = element.serializeWorkspace();
        element.activeRequests = old;
        assert.deepEqual(result.requests, []);
      });

      test('Sets environment', () => {
        element.environment = 'other-env';
        const result = element.serializeWorkspace();
        assert.equal(result.environment, 'other-env');
      });

      test('Sets default selected', () => {
        element.selected = 3;
        const result = element.serializeWorkspace();
        assert.equal(result.selected, 3);
      });

      test('Sets requests', () => {
        element.activeRequests = DataGenerator.generateRequests({
          requestsSize: 2
        });
        const result = element.serializeWorkspace();
        assert.deepEqual(result.requests, element.activeRequests);
      });
    });

    suite('_notifyStoreWorkspace()', () => {
      let element;
      setup(() => {
        element = fixture('Basic');
        element._setInitialized(true);
      });

      test('Calls serializeWorkspace()', () => {
        const spy = sinon.spy(element, 'serializeWorkspace');
        element._notifyStoreWorkspace();
        assert.isTrue(spy.called);
      });

      test('Calls _dispatch() with arguments', () => {
        const spy = sinon.spy(element, '_dispatch');
        element._notifyStoreWorkspace();
        assert.isTrue(spy.called);
        assert.equal(spy.args[0][0], 'workspace-state-store', 'Event type is set');
        const compare = element.serializeWorkspace();
        assert.deepEqual(spy.args[0][1].value, compare, 'Detail is set');
      });

      test('Does nothing when not initialized', () => {
        element._setInitialized(false);
        const spy = sinon.spy(element, 'serializeWorkspace');
        element._notifyStoreWorkspace();
        assert.isFalse(spy.called);
      });

      test('Does nothing when restoring', () => {
        element._setRestoring(true);
        const spy = sinon.spy(element, 'serializeWorkspace');
        element._notifyStoreWorkspace();
        assert.isFalse(spy.called);
      });

      test('Dispatches workspace-state-store event', () => {
        let detail;
        element.addEventListener('workspace-state-store', function f(e) {
          element.removeEventListener('workspace-state-store', f);
          e.preventDefault();
          detail = e.detail;
        });
        element._notifyStoreWorkspace();
        assert.typeOf(detail, 'object');
        const compare = element.serializeWorkspace();
        assert.deepEqual(detail.value, compare, 'Detail is set');
      });
    });
  });
  </script>
</body>
</html>
