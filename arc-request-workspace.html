<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../polymer/lib/utils/render-status.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../paper-tabs/paper-tab.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../arc-icons/arc-icons.html">
<link rel="import" href="../paper-item/paper-icon-item.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../request-panel/request-panel.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../paper-progress/paper-progress.html">
<link rel="import" href="../uuid-generator/uuid-generator.html">
<dom-module id="arc-request-workspace">
  <template>
    <style>
    :host {
      display: block;
      @apply --arc-request-workspace;
    }

    .tabs-row {
      background-color: var(--arc-request-workspace-tabs-backgroud-color, rgba(0, 0, 0, 0.05));
      border-bottom: 1px var(--arc-request-workspace-tabs-border-color, #e5e5e5) solid;
      position: relative;
    }

    .tabs-row paper-tabs {
      --paper-tabs-content: {
        @apply --arc-font-common-base;
        height: 100%;
        border-bottom: 0 solid transparent;
        font-style: normal;
        color: var(--arc-request-workspace-tabs-color, rgba(0,0,0,0.87));
      };
    }

    .tab-name {
      font-size: 13px;
      margin-right: 8px;
      max-width: 160px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .close-icon {
      color: rgba(0, 0, 0, 0.78);
      border-radius: 50%;
      width: 16px;
      height: 16px;
    }

    .close-icon:hover {
      color: rgba(255, 255, 255, 0.54);
      background-color: #FF8A65;
    }

    .add-request-button {
      color: #616161;
      height: 40px;
      cursor: pointer;
      margin-top: 4px;
    }

    paper-tab.iron-selected {
      background-color: var(--arc-request-workspace-tabs-selected-background-color, #fff);
    }

    paper-tab {
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      height: calc(100% - 2px);
    }

    paper-progress {
      position: absolute;
      bottom: -5px;
      left: 0;
      right: 0;
      width: 100%;
      display: none;
    }

    :host([restoring]) paper-progress {
      display: block;
    }

    .context-menu-icon {
      color: var(--request-editor-context-menu-icon-color, var(--primary-color));
      @apply --request-editor-context-menu-icon;
    }
    </style>
    <div class="tabs-row">
      <paper-tabs selected="{{selected}}" scrollable>
        <template is="dom-repeat" items="[[activeRequests]]">
          <paper-tab>
            <span class="tab-name">[[_computeTabName(item.name, item.url)]]</span>
            <iron-icon class="close-icon" icon="arc:close" data-index$="[[index]]" on-click="_closeRequest"></iron-icon>
          </paper-tab>
        </template>
        <paper-icon-button class="add-request-button" icon="arc:add" on-click="addEmptyRequest" title="Add new request editor"></paper-icon-button>
      </paper-tabs>
      <paper-progress indeterminate disabled="[[!restoring]]"></paper-progress>
    </div>
    <iron-pages selected="[[selected]]">
      <template is="dom-repeat" items="{{activeRequests}}" on-dom-change="_panelRendered" observe="name">
        <request-panel class="panel" editor-request="{{item}}" data-request-index$="[[index]]">
          <paper-icon-item on-click="_requestStoreHandler" slot="request-context-menu">
            <iron-icon icon="arc:save" class="context-menu-icon" slot="item-icon" title="Save current request"></iron-icon>
            Save
          </paper-icon-item>
          <paper-icon-item on-click="_renderRequestDetail" slot="request-context-menu">
            <iron-icon icon="arc:info-outline" class="context-menu-icon" slot="item-icon" title="Request details"></iron-icon>
            Details
          </paper-icon-item>
          <paper-icon-item on-click="_renderCodeSnippets" slot="request-context-menu">
            <iron-icon icon="arc:code" class="context-menu-icon" slot="item-icon" title="Toggles code snippets view"></iron-icon>
            Code examples
          </paper-icon-item>
          <slot name="request-context-menu" slot="request-context-menu"></slot>
        </request-panel>
      </template>
    </iron-pages>
    <uuid-generator id="uuid"></uuid-generator>
  </template>
  <script>
  /**
   * `arc-request-workspace`
   *
   * A request workspace component for Advanced REST Client that creates a
   * list of requests.
   *
   * The element does not contain any logic responsible for storing and restoring
   * data. To use this component handle `preferences-store` and `preferences-read`
   * custom events. See source for implementation detaild.
   *
   * ## Styling
   *
   * `<arc-request-workspace>` provides the following custom properties and mixins for styling:
   *
   * Custom property | Description | Default
   * ----------------|-------------|----------
   * `--arc-request-workspace` | Mixin applied to this elment | `{}`
   * `--arc-request-workspace-tabs-backgroud-color` | | `rgba(0, 0, 0, 0.05)`
   * `--arc-request-workspace-tabs-border-color` | | `#e5e5e5`
   * `--arc-request-workspace-tabs-color` | | `rgba(0,0,0,0.87)`
   * `--arc-request-workspace-tabs-selected-background-color` | | `#fff`
   *
   * @customElement
   * @polymer
   * @demo demo/index.html
   * @memberof UiElements
   */
  class ArcRequestWorkspace extends Polymer.Element {
    static get is() {return 'arc-request-workspace';}
    static get properties() {
      return {
        /**
         * The OAuth2 redirect URI to pass to the authorization panel.
         */
        redirectUri: String,
        /**
         * Index of selected request panel
         */
        selected: {
          type: Number,
          observer: '_selectedChanged',
          notify: true
        },
        /**
         * List of currently loaded requests
         * @type {Array<Object>}
         */
        activeRequests: {
          type: Array,
          value: function() {
            return [];
          }
        },
        /**
         * Currently selected workspace.
         * When this value change it triggers workspace state change.
         */
        environment: {
          type: String,
          observer: '_envChanged'
        },
        /**
         * If set then workspace restoration process is in progress.
         */
        restoring: {
          type: Boolean,
          readOnly: true,
          value: false,
          notify: true,
          reflectToAttribute: true
        }
      };
    }

    static get observers() {
      return [
        '_requestsListChanged(activeRequests.*)'
      ];
    }

    constructor() {
      super();
      this._envChangedHandler = this._envChangedHandler.bind(this);
      this._requestChangeHandler = this._requestChangeHandler.bind(this);
      this._requestDeleteHandler = this._requestDeleteHandler.bind(this);
    }

    connectedCallback() {
      super.connectedCallback();
      window.addEventListener('selected-environment-changed', this._envChangedHandler);
      window.addEventListener('request-object-changed', this._requestChangeHandler);
      window.addEventListener('request-object-deleted', this._requestDeleteHandler);
      if (!this.activeRequests.length) {
        Polymer.RenderStatus.afterNextRender(this, () => this.restoreWorkspace());
      }
    }

    disconnectedCallback() {
      super.disconnectedCallback();
      window.removeEventListener('selected-environment-changed', this._envChangedHandler);
      window.removeEventListener('request-object-changed', this._requestChangeHandler);
      window.removeEventListener('request-object-deleted', this._requestDeleteHandler);
    }
    /**
     * Restores workspace state.
     * It dispatches `preferences-read` custom event to query for workspace data
     * and restores requests if they were previously stored.
     *
     * @return {Promise}
     */
    restoreWorkspace() {
      if (this.activeRequests.length) {
        this.activeRequests = [];
      }
      this._setRestoring(true);
      const e = new CustomEvent('preferences-read', {
        bubbles: true,
        composed: true,
        cancelable: true,
        detail: {
          type: 'workspace-state'
        }
      });
      this.dispatchEvent(e);
      if (!e.defaultPrevented) {
        const m = '"preferences-read" event for workspace state not handled';
        console.warn(m);
        this.addEmptyRequest();
        this._setRestoring(false);
        return Promise.reject(new Error(m));
      }
      return e.detail.result
      .then((data) => this._restore(data))
      .then(() => {
        Polymer.RenderStatus.afterNextRender(this, () => {
          this._setRestoring(false);
        });
      })
      .catch((cause) => {
        console.warn(cause.message);
        this.addEmptyRequest();
        this._setRestoring(false);
      });
    }
    /**
     * Restores workspace state from previously stored data.
     * @param {Object} state Workspace state object
     */
    _restore(state) {
      if (!state) {
        this.addEmptyRequest();
        return;
      }
      if (state.requests && state.requests.length) {
        this.activeRequests = state.requests;
      } else {
        this.addEmptyRequest();
      }
      if (!isNaN(state.selected)) {
        this.selected = state.selected;
      }
      if (state.environment) {
        this.environment = state.environment;
        this.dispatchEvent(new CustomEvent('selected-environment-changed', {
          bubbles: true,
          composed: true,
          detail: {
            value: state.environment
          }
        }));
      }
    }

    _computeTabName(name, url) {
      if (name) {
        return name;
      }
      if (url) {
        return url;
      }
      return 'New request';
    }
    /**
     * Appends request to the list of `activeRequests` and selects it.
     *
     * @param {Object} request ArcRequest object.
     */
    appendRequest(request) {
      const index = this.push('activeRequests', request);
      this.selected = (index - 1);
    }

    _panelRendered() {
      const panels = this.shadowRoot.querySelectorAll('request-panel');
      for (let i = 0, len = panels.length; i < len; i++) {
        if (!panels[i].eventsTarget) {
          panels[i].eventsTarget = panels[i];
        }
      }
    }
    /**
     * Adds an empty request to the workspace.
     */
    addEmptyRequest() {
      this.appendRequest({
        url: 'http://',
        method: 'GET'
      });
    }

    _closeRequest(e) {
      e.preventDefault();
      e.stopPropagation();
      let index = Number(e.currentTarget.dataset.index);
      if (isNaN(index)) {
        return;
      }
      this.splice('activeRequests', index, 1);
      if (index === this.selected) {
        index--;
      }
      if (index < 0) {
        index = 0;
      }
      this.selected = index;
      if (!this.activeRequests.length) {
        Polymer.RenderStatus.afterNextRender(this, () => {
          this.addEmptyRequest();
        });
      }
    }
    /**
     * Serializes workspace state to a JavaScript object.
     * @return {Object} An ArcWorkspace object
     */
    serializeWorkspace() {
      const result = {
        environment: this.environment || 'default',
        selected: this.selected || 0,
        requests: this.activeRequests || []
      };
      return result;
    }
    /**
     * Dispatches `preferences-store` custom event to store workspace data.
     * The type of the request is `workspace-state`.
     *
     * If there's an error it is not rerported back to the user.
     */
    _notifyStoreWorkspace() {
      const value = this.serializeWorkspace();
      const e = new CustomEvent('preferences-store', {
        bubbles: true,
        composed: true,
        cancelable: true,
        detail: {
          type: 'workspace-state',
          value
        }
      });
      this.dispatchEvent(e);
      if (!e.defaultPrevented) {
        const m = '"preferences-store" event for workspace state not handled';
        console.warn(m);
      }
    }
    /**
     * Update tabs selection.
     */
    refreshTabs() {
      this.shadowRoot.querySelector('paper-tabs').notifyResize();
    }
    /**
     * Notifies workspace state change when selected request changes.
     */
    _selectedChanged() {
      if (this.restoring) {
        return;
      }
      this._notifyStoreWorkspace();
    }
    /**
     * Notifies workspace state change when request data changes.
     *
     * @param {Object} record Requests record change
     */
    _requestsListChanged(record) {
      if (this.restoring) {
        return;
      }
      switch (record.path) {
        case 'activeRequests':
        case 'activeRequests.length':
          return;
        case 'activeRequests.splices':
          if (!record.value.keySplices || !record.value.keySplices[0].removed.length) {
            return;
          }
      }
      this._notifyStoreWorkspace();
      this.refreshTabs();
    }
    /**
     * Updates environment value in the state file when it's value change.
     *
     * @param {CustomEvent} e
     */
    _envChangedHandler(e) {
      if (e.composedPath()[0] === this || this.restoring) {
        return;
      }
      const value = e.detail.value;
      this.environment = value;
    }
    /**
     * Notifies workspace change when environment changes.
     */
    _envChanged() {
      if (this.restoring) {
        return;
      }
      this._notifyStoreWorkspace();
    }

    /**
     * Finds requests index in the list of active requests.
     *
     * @param {String} requestId Saved request ID
     * @return {Number} Request index or -1 if not found.
     */
    findRequestIndex(requestId) {
      if (!requestId) {
        return -1;
      }
      return this.activeRequests.findIndex((item) => item._id === requestId);
    }
    /**
     * It ensures `_id` property exists and dispatches `request-save-state`
     * event with `request` object on the detail.
     *
     * @param {CustomEvent} e
     */
    _requestStoreHandler(e) {
      e.preventDefault();
      e.stopPropagation();
      const item = e.model.get('item');
      if (!item._id) {
        item._id = this.$.uuid.generate();
      }
      this.dispatchEvent(new CustomEvent('request-save-state', {
        composed: true,
        bubbles: true,
        cancelable: true,
        detail: {
          request: item
        }
      }));
    }
    /**
     * Dispatches `request-details` event with `request` object on the
     * detail.
     *
     * @param {CustomEvent} e
     */
    _renderRequestDetail(e) {
      e.preventDefault();
      e.stopPropagation();
      const item = e.model.get('item');
      this.dispatchEvent(new CustomEvent('request-details', {
        composed: true,
        bubbles: true,
        cancelable: true,
        detail: {
          request: item
        }
      }));
    }
    /**
     * Dispatches `request-code-snippets` event with `request` object on the
     * detail.
     *
     * @param {CustomEvent} e
     */
    _renderCodeSnippets(e) {
      e.preventDefault();
      e.stopPropagation();
      const item = e.model.get('item');
      this.dispatchEvent(new CustomEvent('request-code-snippets', {
        composed: true,
        bubbles: true,
        cancelable: true,
        detail: {
          request: item
        }
      }));
    }
    /**
     * Handler for non cancelable `request-object-changed` custom event.
     * Updates request object if it's one of currently opened objects.
     * @param {CustomEvent} e
     */
    _requestChangeHandler(e) {
      if (e.cancelable) {
        return;
      }
      const index = this.findRequestIndex(e.detail.request._id);
      if (index === -1) {
        return;
      }
      this.set(`activeRequests.${index}`, e.detail.request);
    }
    /**
     * A handler for `request-object-deleted` custom event.
     * Checks if deleted request is one of curerently rendered. If found it
     * removes information related to "saved" request.
     *
     * @param {CustomEvent} e
     */
    _requestDeleteHandler(e) {
      if (e.cancelable) {
        return;
      }
      const index = this.findRequestIndex(e.detail.id);
      if (index === -1) {
        return;
      }
      const request = this.activeRequests[index];
      delete request.name;
      delete request.type;
      delete request.driveId;
      delete request.projects;
      delete request._id;
      delete request._rev;
      delete request.created;
      delete request.updated;
      this.set(`activeRequests.${index}`, request);
      this.set(`activeRequests.${index}.name`, '');
    }
  }
  window.customElements.define(ArcRequestWorkspace.is, ArcRequestWorkspace);
  </script>
</dom-module>
